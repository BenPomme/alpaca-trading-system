<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Modular Trading System Dashboard - ML Optimization Monitoring</title>
    <link rel="stylesheet" href="assets/css/dashboard.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom Enhanced Styles -->
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --background-dark: #0f172a;
            --background-light: #1e293b;
            --text-light: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
        }

        .ml-section {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
            border: 1px solid var(--primary-color);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }

        .ml-optimization-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .optimization-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .parameter-change {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            border-left: 4px solid var(--success-color);
        }

        .parameter-change.negative {
            border-left-color: var(--danger-color);
        }

        .module-performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .module-card {
            background: var(--background-light);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .module-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        }

        .module-card.options::before {
            background: linear-gradient(90deg, #8b5cf6, #a855f7);
        }

        .module-card.crypto::before {
            background: linear-gradient(90deg, #f59e0b, #f97316);
        }

        .module-card.stocks::before {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.healthy {
            background: var(--success-color);
            box-shadow: 0 0 8px var(--success-color);
        }

        .status-indicator.warning {
            background: var(--warning-color);
            box-shadow: 0 0 8px var(--warning-color);
        }

        .status-indicator.error {
            background: var(--danger-color);
            box-shadow: 0 0 8px var(--danger-color);
        }

        .real-time-updates {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .optimization-timeline {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .timeline-time {
            color: var(--text-muted);
            font-size: 11px;
            min-width: 60px;
        }

        .confidence-meter {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin: 5px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--danger-color), var(--warning-color), var(--success-color));
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .metric-trend {
            font-size: 12px;
            margin-left: 8px;
        }

        .metric-trend.up {
            color: var(--success-color);
        }

        .metric-trend.down {
            color: var(--danger-color);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .firebase-status {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 14px;
        }

        .firebase-status.connected {
            color: var(--success-color);
        }

        .firebase-status.disconnected {
            color: var(--danger-color);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Enhanced Header with Real-time Status -->
        <header class="dashboard-header">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <h1>üß† Modular Trading System Dashboard</h1>
                <div class="firebase-status" id="firebase-status">
                    <span class="status-indicator" id="firebase-indicator"></span>
                    <span id="firebase-text">Connecting to Firebase...</span>
                </div>
            </div>
            
            <div class="header-stats">
                <div class="stat-card">
                    <span class="stat-label">Portfolio Value</span>
                    <span class="stat-value" id="portfolio-value">$0.00</span>
                    <span class="metric-trend" id="portfolio-trend"></span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Daily P&L</span>
                    <span class="stat-value" id="daily-pl">$0.00</span>
                    <span class="metric-trend" id="daily-pl-trend"></span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Win Rate</span>
                    <span class="stat-value" id="win-rate">0%</span>
                    <span class="metric-trend" id="win-rate-trend"></span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Active Positions</span>
                    <span class="stat-value" id="active-positions">0</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">ML Optimizations Today</span>
                    <span class="stat-value" id="ml-optimizations-today">0</span>
                </div>
            </div>
            <div class="last-updated" id="last-updated">Last updated: <span class="loading-spinner"></span></div>
        </header>

        <!-- Real-time Updates Indicator -->
        <div class="real-time-updates" id="real-time-indicator">
            <span class="status-indicator healthy"></span>
            Real-time updates active
        </div>

        <!-- Main Dashboard Grid -->
        <main class="dashboard-grid">
            
            <!-- ML Optimization Status Section -->
            <section class="card ml-section">
                <h2>üß† ML Parameter Optimization Status</h2>
                
                <div class="ml-optimization-status">
                    <div class="optimization-card">
                        <h4>Optimization Engine</h4>
                        <div class="firebase-status" id="ml-engine-status">
                            <span class="status-indicator" id="ml-engine-indicator"></span>
                            <span id="ml-engine-text">Loading...</span>
                        </div>
                        <div>Next optimization in: <span id="next-optimization-time">Calculating...</span></div>
                    </div>
                    
                    <div class="optimization-card">
                        <h4>Parameters Changed Today</h4>
                        <div style="font-size: 24px; font-weight: bold;" id="params-changed-today">0</div>
                        <div>Expected improvement: <span id="expected-improvement">0.0%</span></div>
                    </div>
                    
                    <div class="optimization-card">
                        <h4>Optimization Confidence</h4>
                        <div style="font-size: 18px;" id="optimization-confidence">0%</div>
                        <div class="confidence-meter">
                            <div class="confidence-fill" id="confidence-meter" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="optimization-card">
                        <h4>Data Points Available</h4>
                        <div style="font-size: 20px;" id="ml-data-points">0</div>
                        <div>Across all modules</div>
                    </div>
                </div>

                <!-- Recent Parameter Changes -->
                <h3>Recent Parameter Optimizations</h3>
                <div class="optimization-timeline" id="optimization-timeline">
                    <div class="timeline-item">
                        <span class="timeline-time">Loading...</span>
                        <span>Fetching recent optimizations...</span>
                    </div>
                </div>
            </section>

            <!-- Module Performance Grid -->
            <section class="card">
                <h2>üìä Module Performance Monitoring</h2>
                <div class="module-performance-grid" id="module-performance-grid">
                    <!-- Options Module -->
                    <div class="module-card options">
                        <h3>üéØ Options Module</h3>
                        <div class="firebase-status" id="options-status">
                            <span class="status-indicator" id="options-indicator"></span>
                            <span id="options-status-text">Loading...</span>
                        </div>
                        <div class="module-metrics" id="options-metrics">
                            <div>Trades: <span id="options-trades">0</span></div>
                            <div>Win Rate: <span id="options-win-rate">0%</span></div>
                            <div>Total P&L: <span id="options-pnl">$0.00</span></div>
                            <div>Last Trade: <span id="options-last-trade">None</span></div>
                        </div>
                    </div>

                    <!-- Crypto Module -->
                    <div class="module-card crypto">
                        <h3>‚Çø Crypto Module</h3>
                        <div class="firebase-status" id="crypto-status">
                            <span class="status-indicator" id="crypto-indicator"></span>
                            <span id="crypto-status-text">Loading...</span>
                        </div>
                        <div class="module-metrics" id="crypto-metrics">
                            <div>Trades: <span id="crypto-trades">0</span></div>
                            <div>Win Rate: <span id="crypto-win-rate">0%</span></div>
                            <div>Total P&L: <span id="crypto-pnl">$0.00</span></div>
                            <div>Last Trade: <span id="crypto-last-trade">None</span></div>
                        </div>
                    </div>

                    <!-- Stocks Module -->
                    <div class="module-card stocks">
                        <h3>üìà Stocks Module</h3>
                        <div class="firebase-status" id="stocks-status">
                            <span class="status-indicator" id="stocks-indicator"></span>
                            <span id="stocks-status-text">Loading...</span>
                        </div>
                        <div class="module-metrics" id="stocks-metrics">
                            <div>Trades: <span id="stocks-trades">0</span></div>
                            <div>Win Rate: <span id="stocks-win-rate">0%</span></div>
                            <div>Total P&L: <span id="stocks-pnl">$0.00</span></div>
                            <div>Last Trade: <span id="stocks-last-trade">None</span></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Orchestrator Status -->
            <section class="card">
                <h2>üéº Orchestrator Status</h2>
                <div class="orchestrator-metrics" id="orchestrator-metrics">
                    <div class="firebase-status" id="orchestrator-status">
                        <span class="status-indicator" id="orchestrator-indicator"></span>
                        <span id="orchestrator-status-text">Loading...</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <strong>Last Cycle:</strong>
                            <div id="last-cycle-time">Loading...</div>
                        </div>
                        <div>
                            <strong>Cycle Number:</strong>
                            <div id="cycle-number">0</div>
                        </div>
                        <div>
                            <strong>Success Rate:</strong>
                            <div id="orchestrator-success-rate">0%</div>
                        </div>
                        <div>
                            <strong>Uptime:</strong>
                            <div id="orchestrator-uptime">Unknown</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Portfolio Performance Chart -->
            <section class="card">
                <h2>üìà Performance Charts</h2>
                <div class="chart-container">
                    <canvas id="performance-chart"></canvas>
                </div>
            </section>

            <!-- Active Positions -->
            <section class="card positions-container">
                <h2>üíº Active Positions</h2>
                <div class="positions-header">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="stocks">Stocks</button>
                    <button class="filter-btn" data-filter="crypto">Crypto</button>
                    <button class="filter-btn" data-filter="options">Options</button>
                </div>
                <div class="positions-table-container">
                    <table class="positions-table" id="positions-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Module</th>
                                <th>Qty</th>
                                <th>Entry Price</th>
                                <th>Current Price</th>
                                <th>P&L</th>
                                <th>P&L %</th>
                                <th>Hold Time</th>
                                <th>Strategy</th>
                            </tr>
                        </thead>
                        <tbody id="positions-tbody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 20px;">
                                    <span class="loading-spinner"></span> Loading positions...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Recent Trades with ML Data -->
            <section class="card trades-container">
                <h2>üìã Recent Trades</h2>
                <div class="trades-table-container">
                    <table class="trades-table" id="trades-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Symbol</th>
                                <th>Module</th>
                                <th>Side</th>
                                <th>Strategy</th>
                                <th>P&L</th>
                                <th>Confidence</th>
                                <th>ML Enhanced</th>
                            </tr>
                        </thead>
                        <tbody id="trades-tbody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 20px;">
                                    <span class="loading-spinner"></span> Loading trades...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Parameter Effectiveness Analysis -->
            <section class="card">
                <h2>üéØ Parameter Effectiveness Analysis</h2>
                <div id="parameter-effectiveness">
                    <h4>Top Performing Parameters</h4>
                    <div id="top-parameters">Loading...</div>
                    
                    <h4>Parameters Needing Optimization</h4>
                    <div id="underperforming-parameters">Loading...</div>
                </div>
            </section>

        </main>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <p>ü§ñ Modular Trading System with ML Optimization | Connected to Firebase</p>
            <p>Last Firebase sync: <span id="footer-sync-time">Never</span></p>
        </footer>
    </div>

    <!-- Firebase Configuration and Dashboard Script -->
    <script type="module">
        // Firebase configuration
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, getDocs } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase config - Connected to "alpaca dashboard" app
        const firebaseConfig = {
            apiKey: "AIzaSyBI0T8hMlzbz45mXrY-fXNF1m2bCg-D_EM",
            authDomain: "alpaca-12fab.firebaseapp.com",
            projectId: "alpaca-12fab",
            storageBucket: "alpaca-12fab.firebasestorage.app",
            messagingSenderId: "331366849839",
            appId: "1:331366849839:web:9a27ca63e1da1cd4e855da",
            measurementId: "G-STJBCT0RFE"
        };

        // Initialize Firebase
        let app, db, isConnected = false;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            
            // Test connection
            const testQuery = query(collection(db, 'orchestrator_cycles'), limit(1));
            getDocs(testQuery).then(() => {
                isConnected = true;
                updateConnectionStatus(true);
                startRealTimeUpdates();
            }).catch(error => {
                console.warn('Firebase connection failed, using fallback data:', error);
                updateConnectionStatus(false);
                loadFallbackData();
            });
            
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            updateConnectionStatus(false);
            loadFallbackData();
        }

        // Update connection status indicators
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('firebase-status');
            const indicatorElement = document.getElementById('firebase-indicator');
            const textElement = document.getElementById('firebase-text');
            
            if (connected) {
                statusElement.className = 'firebase-status connected';
                indicatorElement.className = 'status-indicator healthy';
                textElement.textContent = 'Connected to Firebase';
                document.getElementById('real-time-indicator').style.display = 'block';
            } else {
                statusElement.className = 'firebase-status disconnected';
                indicatorElement.className = 'status-indicator error';
                textElement.textContent = 'Firebase Disconnected';
                document.getElementById('real-time-indicator').style.display = 'none';
            }
        }

        // Start real-time Firebase listeners
        function startRealTimeUpdates() {
            // Listen to orchestrator cycles
            const orchestratorQuery = query(
                collection(db, 'orchestrator_cycles'),
                orderBy('timestamp', 'desc'),
                limit(10)
            );
            
            onSnapshot(orchestratorQuery, (snapshot) => {
                const cycles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateOrchestratorStatus(cycles);
                updateLastUpdated();
            });

            // Listen to modular trades
            const tradesQuery = query(
                collection(db, 'modular_trades'),
                orderBy('timestamp', 'desc'),
                limit(50)
            );
            
            onSnapshot(tradesQuery, (snapshot) => {
                const trades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateTradesTable(trades);
                updateModulePerformance(trades);
                updatePerformanceMetrics(trades);
            });

            // Listen to ML optimization data
            const mlQuery = query(
                collection(db, 'ml_optimization_data'),
                orderBy('timestamp', 'desc'),
                limit(20)
            );
            
            onSnapshot(mlQuery, (snapshot) => {
                const optimizations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateMLOptimizationStatus(optimizations);
            });

            // Listen to parameter effectiveness
            const paramQuery = query(
                collection(db, 'parameter_effectiveness'),
                orderBy('timestamp', 'desc'),
                limit(100)
            );
            
            onSnapshot(paramQuery, (snapshot) => {
                const parameters = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateParameterEffectiveness(parameters);
            });
        }

        // Update orchestrator status
        function updateOrchestratorStatus(cycles) {
            if (cycles.length === 0) {
                document.getElementById('orchestrator-status-text').textContent = 'No recent cycles';
                document.getElementById('orchestrator-indicator').className = 'status-indicator warning';
                return;
            }

            const latestCycle = cycles[0];
            const successfulCycles = cycles.filter(c => c.results?.success).length;
            const successRate = (successfulCycles / cycles.length * 100).toFixed(1);

            document.getElementById('orchestrator-status-text').textContent = 'Active';
            document.getElementById('orchestrator-indicator').className = 'status-indicator healthy';
            document.getElementById('last-cycle-time').textContent = formatTimestamp(latestCycle.timestamp);
            document.getElementById('cycle-number').textContent = latestCycle.cycle_number || 0;
            document.getElementById('orchestrator-success-rate').textContent = `${successRate}%`;
            
            // Calculate uptime
            const lastCycleTime = new Date(latestCycle.timestamp);
            const now = new Date();
            const uptimeHours = Math.max(0, (now - lastCycleTime) / (1000 * 60 * 60));
            
            if (uptimeHours < 0.17) { // Less than 10 minutes
                document.getElementById('orchestrator-uptime').textContent = 'Active';
            } else if (uptimeHours < 24) {
                document.getElementById('orchestrator-uptime').textContent = `${uptimeHours.toFixed(1)}h ago`;
            } else {
                document.getElementById('orchestrator-uptime').textContent = 'Stale';
                document.getElementById('orchestrator-indicator').className = 'status-indicator warning';
            }
        }

        // Update trades table
        function updateTradesTable(trades) {
            const tbody = document.getElementById('trades-tbody');
            
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No recent trades found</td></tr>';
                return;
            }

            tbody.innerHTML = trades.slice(0, 20).map(trade => {
                const pnlClass = (trade.pnl || 0) >= 0 ? 'positive' : 'negative';
                const mlEnhanced = trade.ml_enhanced ? '‚úÖ' : '‚ùå';
                
                return `
                    <tr>
                        <td>${formatTimestamp(trade.timestamp)}</td>
                        <td>${trade.symbol || 'N/A'}</td>
                        <td>${trade.module_name || 'N/A'}</td>
                        <td>${trade.action || 'N/A'}</td>
                        <td>${trade.strategy || 'N/A'}</td>
                        <td class="${pnlClass}">$${(trade.pnl || 0).toFixed(2)}</td>
                        <td>${(trade.confidence * 100 || 0).toFixed(1)}%</td>
                        <td>${mlEnhanced}</td>
                    </tr>
                `;
            }).join('');
        }

        // Update module performance
        function updateModulePerformance(trades) {
            const modules = ['options', 'crypto', 'stocks'];
            
            modules.forEach(moduleName => {
                const moduleTrades = trades.filter(trade => trade.module_name === moduleName);
                
                if (moduleTrades.length > 0) {
                    const winningTrades = moduleTrades.filter(trade => (trade.pnl || 0) > 0).length;
                    const winRate = (winningTrades / moduleTrades.length * 100).toFixed(1);
                    const totalPnl = moduleTrades.reduce((sum, trade) => sum + (trade.pnl || 0), 0);
                    const lastTrade = moduleTrades[0];

                    document.getElementById(`${moduleName}-status-text`).textContent = 'Active';
                    document.getElementById(`${moduleName}-indicator`).className = 'status-indicator healthy';
                    document.getElementById(`${moduleName}-trades`).textContent = moduleTrades.length;
                    document.getElementById(`${moduleName}-win-rate`).textContent = `${winRate}%`;
                    document.getElementById(`${moduleName}-pnl`).textContent = `$${totalPnl.toFixed(2)}`;
                    document.getElementById(`${moduleName}-last-trade`).textContent = lastTrade.symbol || 'N/A';
                } else {
                    document.getElementById(`${moduleName}-status-text`).textContent = 'No recent trades';
                    document.getElementById(`${moduleName}-indicator`).className = 'status-indicator warning';
                    document.getElementById(`${moduleName}-trades`).textContent = '0';
                    document.getElementById(`${moduleName}-win-rate`).textContent = '0%';
                    document.getElementById(`${moduleName}-pnl`).textContent = '$0.00';
                    document.getElementById(`${moduleName}-last-trade`).textContent = 'None';
                }
            });
        }

        // Update ML optimization status
        function updateMLOptimizationStatus(optimizations) {
            const today = new Date().toDateString();
            const todayOptimizations = optimizations.filter(opt => 
                opt.applied && new Date(opt.timestamp).toDateString() === today
            );

            document.getElementById('ml-engine-status').className = 'firebase-status connected';
            document.getElementById('ml-engine-indicator').className = 'status-indicator healthy';
            document.getElementById('ml-engine-text').textContent = 'Active';
            
            document.getElementById('params-changed-today').textContent = todayOptimizations.length;
            document.getElementById('ml-optimizations-today').textContent = todayOptimizations.length;

            const expectedImprovement = todayOptimizations.reduce((sum, opt) => 
                sum + (opt.expected_improvement || 0), 0
            );
            document.getElementById('expected-improvement').textContent = `${(expectedImprovement * 100).toFixed(1)}%`;

            // Update optimization timeline
            const timeline = document.getElementById('optimization-timeline');
            if (optimizations.length > 0) {
                timeline.innerHTML = optimizations.slice(0, 10).map(opt => {
                    const changeClass = (opt.expected_improvement || 0) >= 0 ? '' : ' negative';
                    return `
                        <div class="timeline-item">
                            <span class="timeline-time">${formatTime(opt.timestamp)}</span>
                            <div class="parameter-change${changeClass}">
                                <span>${opt.module_name}: ${opt.parameter_type}</span>
                                <span>${opt.old_value} ‚Üí ${opt.new_value}</span>
                                <span>${((opt.expected_improvement || 0) * 100).toFixed(1)}%</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                timeline.innerHTML = '<div class="timeline-item"><span>No recent optimizations</span></div>';
            }

            // Update confidence meter
            const avgConfidence = optimizations.length > 0 ? 
                optimizations.reduce((sum, opt) => sum + (opt.confidence || 0), 0) / optimizations.length : 0;
            document.getElementById('optimization-confidence').textContent = `${(avgConfidence * 100).toFixed(1)}%`;
            document.getElementById('confidence-meter').style.width = `${avgConfidence * 100}%`;
        }

        // Update parameter effectiveness
        function updateParameterEffectiveness(parameters) {
            const paramTypes = {};
            
            parameters.forEach(param => {
                const type = param.parameter_type;
                if (!paramTypes[type]) {
                    paramTypes[type] = { total: 0, successful: 0, totalPnl: 0 };
                }
                paramTypes[type].total++;
                if (param.success) paramTypes[type].successful++;
                paramTypes[type].totalPnl += param.profit_loss || 0;
            });

            const topParams = Object.entries(paramTypes)
                .map(([type, stats]) => ({
                    type,
                    winRate: stats.total > 0 ? (stats.successful / stats.total * 100) : 0,
                    avgPnl: stats.total > 0 ? (stats.totalPnl / stats.total) : 0,
                    total: stats.total
                }))
                .filter(param => param.total >= 3)
                .sort((a, b) => b.avgPnl - a.avgPnl);

            const topPerforming = topParams.filter(p => p.winRate > 60 && p.avgPnl > 0);
            const underperforming = topParams.filter(p => p.winRate < 40 || p.avgPnl < -5);

            document.getElementById('top-parameters').innerHTML = topPerforming.length > 0 ? 
                topPerforming.slice(0, 5).map(param => `
                    <div class="parameter-change">
                        <span>${param.type}</span>
                        <span>Win Rate: ${param.winRate.toFixed(1)}%</span>
                        <span>Avg P&L: $${param.avgPnl.toFixed(2)}</span>
                    </div>
                `).join('') : '<div>No top-performing parameters identified yet</div>';

            document.getElementById('underperforming-parameters').innerHTML = underperforming.length > 0 ?
                underperforming.slice(0, 3).map(param => `
                    <div class="parameter-change negative">
                        <span>${param.type}</span>
                        <span>Win Rate: ${param.winRate.toFixed(1)}%</span>
                        <span>Avg P&L: $${param.avgPnl.toFixed(2)}</span>
                    </div>
                `).join('') : '<div>No underperforming parameters identified</div>';

            document.getElementById('ml-data-points').textContent = parameters.length;
        }

        // Update performance metrics
        function updatePerformanceMetrics(trades) {
            if (trades.length === 0) return;

            const winningTrades = trades.filter(trade => (trade.pnl || 0) > 0);
            const winRate = (winningTrades.length / trades.length * 100).toFixed(1);
            const totalPnl = trades.reduce((sum, trade) => sum + (trade.pnl || 0), 0);

            document.getElementById('win-rate').textContent = `${winRate}%`;
            document.getElementById('daily-pl').textContent = `$${totalPnl.toFixed(2)}`;
            
            // Add trend indicators
            const recentTrades = trades.slice(0, 10);
            const olderTrades = trades.slice(10, 20);
            
            if (olderTrades.length > 0) {
                const recentWinRate = recentTrades.filter(t => (t.pnl || 0) > 0).length / recentTrades.length * 100;
                const olderWinRate = olderTrades.filter(t => (t.pnl || 0) > 0).length / olderTrades.length * 100;
                
                const trendElement = document.getElementById('win-rate-trend');
                if (recentWinRate > olderWinRate) {
                    trendElement.textContent = '‚Üó';
                    trendElement.className = 'metric-trend up';
                } else if (recentWinRate < olderWinRate) {
                    trendElement.textContent = '‚Üò';
                    trendElement.className = 'metric-trend down';
                } else {
                    trendElement.textContent = '‚Üí';
                    trendElement.className = 'metric-trend';
                }
            }
        }

        // Load fallback data when Firebase is unavailable
        function loadFallbackData() {
            // Try to load from API data first
            loadApiData().catch(() => {
                // If API fails, use hardcoded fallback
                document.getElementById('portfolio-value').textContent = '$99,500.00';
                document.getElementById('daily-pl').textContent = '-$500.00';
                document.getElementById('win-rate').textContent = '57.8%';
                document.getElementById('active-positions').textContent = '12';
                document.getElementById('ml-optimizations-today').textContent = '3';
                
                // Mock orchestrator status
                document.getElementById('orchestrator-status-text').textContent = 'Offline';
                document.getElementById('orchestrator-indicator').className = 'status-indicator error';
                document.getElementById('last-cycle-time').textContent = 'Unknown';
                document.getElementById('cycle-number').textContent = '0';
                
                // Mock ML status
                document.getElementById('ml-engine-text').textContent = 'Offline';
                document.getElementById('ml-engine-indicator').className = 'status-indicator error';
                
                updateLastUpdated();
            });
        }

        // Load data from API endpoint
        async function loadApiData() {
            try {
                console.log('Loading data from API...');
                const response = await fetch('./api/modular-dashboard-data.json?v=' + Date.now());
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                console.log('API data loaded:', data);
                
                // Update header stats
                updateHeaderStatsFromApi(data);
                
                // Update positions table
                updatePositionsFromApi(data.positions || []);
                
                // Update trades table
                updateTradesFromApi(data.trades || []);
                
                // Update ML optimization status
                updateMLOptimizationFromApi(data);
                
                // Update module performance
                updateModulePerformanceFromApi(data);
                
                // Update orchestrator status
                updateOrchestratorFromApi(data.orchestrator || {});
                
                updateLastUpdated();
                
            } catch (error) {
                console.error('Failed to load API data:', error);
                throw error;
            }
        }

        // Update header stats from API data
        function updateHeaderStatsFromApi(data) {
            const portfolio = data.portfolio || {};
            
            document.getElementById('portfolio-value').textContent = 
                '$' + (portfolio.value || 0).toLocaleString('en-US', { minimumFractionDigits: 2 });
            
            const dailyPL = portfolio.daily_pl || 0;
            const dailyPLElement = document.getElementById('daily-pl');
            dailyPLElement.textContent = 
                (dailyPL >= 0 ? '+$' : '-$') + Math.abs(dailyPL).toLocaleString('en-US', { minimumFractionDigits: 2 });
            dailyPLElement.className = `stat-value ${dailyPL >= 0 ? 'positive' : 'negative'}`;
            
            const performance = data.performance || {};
            document.getElementById('win-rate').textContent = (performance.win_rate || 0).toFixed(1) + '%';
            document.getElementById('active-positions').textContent = (data.positions || []).length.toString();
            
            const mlOpt = data.ml_optimization || {};
            document.getElementById('ml-optimizations-today').textContent = (mlOpt.parameter_changes_today || 0).toString();
        }

        // Update positions table from API data
        function updatePositionsFromApi(positions) {
            const tbody = document.getElementById('positions-tbody');
            
            if (!positions || positions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No active positions</td></tr>';
                return;
            }
            
            tbody.innerHTML = positions.slice(0, 20).map(position => {
                const plClass = (position.unrealized_pl || 0) >= 0 ? 'positive' : 'negative';
                const plSign = (position.unrealized_pl || 0) >= 0 ? '+' : '';
                
                return `
                    <tr>
                        <td><strong>${position.symbol || 'N/A'}</strong></td>
                        <td>${position.module || 'N/A'}</td>
                        <td>${position.quantity || 0}</td>
                        <td>$${(position.entry_price || 0).toFixed(2)}</td>
                        <td>$${(position.current_price || 0).toFixed(2)}</td>
                        <td class="${plClass}">${plSign}$${Math.abs(position.unrealized_pl || 0).toFixed(2)}</td>
                        <td class="${plClass}">${plSign}${(position.unrealized_pl_percent || 0).toFixed(2)}%</td>
                        <td>${position.hold_time || 'N/A'}</td>
                        <td><span class="strategy-tag">${position.strategy || 'N/A'}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Update trades table from API data
        function updateTradesFromApi(trades) {
            const tbody = document.getElementById('trades-tbody');
            
            if (!trades || trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No recent trades</td></tr>';
                return;
            }
            
            tbody.innerHTML = trades.slice(0, 20).map(trade => {
                const plClass = (trade.pnl || 0) >= 0 ? 'positive' : 'negative';
                const mlEnhanced = trade.ml_enhanced ? '‚úÖ' : '‚ùå';
                
                return `
                    <tr>
                        <td>${formatTimestamp(trade.timestamp)}</td>
                        <td>${trade.symbol || 'N/A'}</td>
                        <td>${trade.module_name || 'N/A'}</td>
                        <td>${trade.action || 'N/A'}</td>
                        <td>${trade.strategy || 'N/A'}</td>
                        <td class="${plClass}">$${(trade.pnl || 0).toFixed(2)}</td>
                        <td>${(trade.confidence * 100 || 0).toFixed(1)}%</td>
                        <td>${mlEnhanced}</td>
                    </tr>
                `;
            }).join('');
        }

        // Update ML optimization status from API data
        function updateMLOptimizationFromApi(data) {
            const mlOpt = data.ml_optimization || {};
            const paramEff = data.parameter_effectiveness || {};
            
            // Update ML optimization header stats
            document.getElementById('ml-engine-text').textContent = 'Active';
            document.getElementById('ml-engine-indicator').className = 'status-indicator healthy';
            
            document.getElementById('params-changed-today').textContent = mlOpt.parameter_changes_today || 0;
            document.getElementById('ml-optimizations-today').textContent = mlOpt.parameter_changes_today || 0;
            
            const expectedImprovement = (mlOpt.recent_optimizations || [])
                .reduce((sum, opt) => sum + (opt.expected_improvement || 0), 0);
            document.getElementById('expected-improvement').textContent = `${(expectedImprovement * 100).toFixed(1)}%`;
            
            document.getElementById('ml-data-points').textContent = paramEff.parameters_tracked || 0;
            
            // Update optimization timeline
            const timeline = document.getElementById('optimization-timeline');
            const optimizations = mlOpt.recent_optimizations || [];
            
            if (optimizations.length > 0) {
                timeline.innerHTML = optimizations.slice(0, 10).map(opt => {
                    const changeClass = (opt.expected_improvement || 0) >= 0 ? '' : ' negative';
                    return `
                        <div class="timeline-item">
                            <span class="timeline-time">${formatTime(opt.timestamp)}</span>
                            <div class="parameter-change${changeClass}">
                                <span>${opt.module_name}: ${opt.parameter_type}</span>
                                <span>${opt.old_value} ‚Üí ${opt.new_value}</span>
                                <span>+${((opt.expected_improvement || 0) * 100).toFixed(1)}%</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                timeline.innerHTML = '<div class="timeline-item"><span>No recent optimizations</span></div>';
            }
            
            // Update parameter effectiveness
            const topParams = paramEff.top_performing_parameters || [];
            const underParams = paramEff.underperforming_parameters || [];
            
            document.getElementById('top-parameters').innerHTML = topParams.length > 0 ? 
                topParams.map(param => `
                    <div class="parameter-change">
                        <span>${param.parameter_type}</span>
                        <span>Win Rate: ${param.win_rate.toFixed(1)}%</span>
                        <span>Avg P&L: $${param.avg_pnl.toFixed(2)}</span>
                    </div>
                `).join('') : '<div>No top-performing parameters identified yet</div>';
            
            document.getElementById('underperforming-parameters').innerHTML = underParams.length > 0 ?
                underParams.map(param => `
                    <div class="parameter-change negative">
                        <span>${param.parameter_type}</span>
                        <span>Win Rate: ${param.win_rate.toFixed(1)}%</span>
                        <span>Avg P&L: $${param.avg_pnl.toFixed(2)}</span>
                    </div>
                `).join('') : '<div>No underperforming parameters identified</div>';
        }

        // Update module performance from API data
        function updateModulePerformanceFromApi(data) {
            const modules = data.modules || {};
            const moduleNames = ['options', 'crypto', 'stocks'];
            
            moduleNames.forEach(moduleName => {
                const moduleData = modules[moduleName] || {};
                
                document.getElementById(`${moduleName}-status-text`).textContent = 
                    moduleData.total_trades > 0 ? 'Active' : 'No recent trades';
                document.getElementById(`${moduleName}-indicator`).className = 
                    moduleData.total_trades > 0 ? 'status-indicator healthy' : 'status-indicator warning';
                document.getElementById(`${moduleName}-trades`).textContent = moduleData.total_trades || 0;
                document.getElementById(`${moduleName}-win-rate`).textContent = `${(moduleData.win_rate || 0).toFixed(1)}%`;
                document.getElementById(`${moduleName}-pnl`).textContent = `$${(moduleData.total_pnl || 0).toFixed(2)}`;
                document.getElementById(`${moduleName}-last-trade`).textContent = 
                    moduleData.total_trades > 0 ? 'Recent' : 'None';
            });
        }

        // Update orchestrator status from API data
        function updateOrchestratorFromApi(orchestrator) {
            document.getElementById('orchestrator-status-text').textContent = 
                orchestrator.uptime_status === 'running' ? 'Active' : 'Inactive';
            document.getElementById('orchestrator-indicator').className = 
                orchestrator.uptime_status === 'running' ? 'status-indicator healthy' : 'status-indicator warning';
            document.getElementById('last-cycle-time').textContent = 
                formatTimestamp(orchestrator.last_cycle_time) || 'Unknown';
            document.getElementById('cycle-number').textContent = orchestrator.cycle_number || 0;
            document.getElementById('orchestrator-success-rate').textContent = 
                `${(orchestrator.success_rate || 0).toFixed(1)}%`;
            document.getElementById('orchestrator-uptime').textContent = 
                orchestrator.uptime_status === 'running' ? 'Active' : 'Stale';
        }

        // Utility functions
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function updateLastUpdated() {
            document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            document.getElementById('footer-sync-time').textContent = new Date().toLocaleTimeString();
        }

        // Initialize dashboard
        if (!isConnected) {
            setTimeout(() => {
                if (!isConnected) {
                    console.log('Firebase connection timeout, loading fallback data');
                    loadFallbackData();
                }
            }, 5000);
        }

    </script>
</body>
</html>